require(sn)
require(rootSolve)


invlogit <-function(y, lb=0, ub=1) {
  (ub-lb)/(1 + exp(-y))+lb
}

logit <-function(x) {
  log(x/(1-x)) 
}

SigmaFromCV <- function (CV) {
  sqrt(log(CV^2+1))
  }

#########################################
################ catch data #############
#########################################

## Korea
catch_data=c(15000, 19000, 19800, 21000, 26600, 18500, 13900, 12800, 5800, 1600, 2100, 1800, 4100, 5400, 2400, 7300, 
                   2000, 2800, 10500, 42100, 38256,	60599,	78969,	74150,	80649,	70123,	107382,	113051,	99519,	120283,	62690,	108082,	99447,	122883,	101714,	68479,
                   103511,	101337,	162828,	163617,	96297,	89738,	115619,	174684,	210442,	200481,	415003,	160448,	172925,	177540,	145908,	203717,
                   141751,	122044,	184274,	135596,	101427,	143776,	187240,	117960,	94331,	138729,	125143,	102114,	127450,	131735,	133200,	103870,	141530,	101121,
                   77603, 121770)

names(catch_data)<-1950:2021

## china
catch_data_china=c(27200, 39200, 49600, 50400, 61400, 67100, 78000, 76000, 76000, 80000, 80000, 80000, 
                   84000, 84000, 84000, 88000, 88000, 88000, 92000, 92000, 173100, 36600, 78300, 93100, 113547, 84487, 78965, 134852, 282262, 111637, 
                   83760, 73466, 107005, 153932, 123933, 92573, 132196, 166039, 240699, 231625, 196823, 242639, 243143, 272604, 336091, 372038, 374400, 377938, 341390, 349146,
                   300903, 325527, 353382, 370747, 382927, 418677, 436758, 343821, 592637, 397010, 492005, 563179, 509546, 511500, 480425, 471211, 448603, 444839, 432504, 479156, 392556)

names(catch_data_china)<-1950:2020

## japan
catch_data_japan=c(177900, 141300, 271700, 234800, 297400, 244400, 266200, 275300, 268400, 294500, 351100, 337800, 408800, 464900, 495700, 668600, 624400, 687500, 
                   1015300, 1011400, 1301900, 1252600, 1188200, 1133700, 1330080, 1317492, 977755, 1353388, 1625753, 1491006, 1300994, 907589, 717512, 804478, 813261, 771419, 
                   944340, 700686, 646196, 524809, 272477, 253991, 266609, 664298, 633062, 469447, 760430, 848967, 511238, 381865, 346220, 375273, 279663, 329273, 
                   338098, 620393, 652397, 456552, 520326, 470904, 491813, 392506, 438269, 374954, 481783, 529977, 502651, 517602, 541975, 450441, 376600)

names(catch_data_japan)<-1950:2020

#########################################
################ Length data ############
#########################################

LengData=structure(c(0, 0, 0, 0, 0, 51, 57, 53, 55, 65, 63, 205, 176, 
                     222, 193, 271, 243, 133, 126, 221, 219, 257, 181, 118, 65, 40, 
                     16, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 
                     87, 58, 153, 156, 73, 44, 133, 261, 437, 576, 731, 1028, 1030, 
                     1023, 797, 656, 439, 456, 329, 277, 157, 94, 43, 40, 16, 23, 
                     41, 69, 62, 71, 38, 11, 12, 0, 0, 0, 0, 0, 0, 0, 3, 8, 80, 78, 
                     37, 46, 31, 41, 93, 329, 423, 370, 393, 628, 956, 981, 1294, 
                     897, 978, 1003, 963, 818, 762, 584, 267, 128, 48, 14, 9, 1, 0, 
                     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 19, 
                     44, 110, 220, 356, 496, 682, 927, 1060, 974, 1075, 977, 1020, 
                     1068, 749, 752, 457, 199, 122, 33, 7, 8, 0, 0, 0, 0, 0, 0, 0, 
                     0, 0, 0, 0, 0, 0, 0, 2, 1, 35, 90, 129, 112, 141, 306, 459, 665, 
                     799, 914, 1004, 1359, 1397, 1286, 1396, 1357, 1144, 887, 534, 
                     346, 274, 185, 226, 146, 63, 36, 5, 1, 0, 1, 0, 0, 0, 0, 0, 0, 
                     0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 25, 81, 150, 242, 307, 339, 
                     510, 730, 981, 1120, 1255, 1148, 953, 543, 213, 107, 88, 42, 
                     26, 19, 14, 20, 16, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 6, 
                     25, 37, 40, 24, 48, 94, 186, 341, 401, 509, 766, 1033, 1069, 
                     1059, 797, 815, 802, 740, 643, 357, 230, 88, 65, 43, 15, 6, 2, 
                     0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 20, 58, 
                     109, 134, 246, 382, 735, 891, 1191, 1429, 1404, 1260, 1116, 1060, 
                     787, 676, 565, 308, 160, 115, 90, 45, 18, 19, 9, 4, 2, 0, 0, 
                     0, 0, 0, 0, 0, 6, 32, 66, 120, 143, 89, 90, 152, 93, 105, 131, 
                     206, 458, 749, 1123, 1017, 763, 1064, 943, 934, 997, 1023, 608, 
                     589, 606, 323, 200, 143, 64, 33, 14, 15, 4, 3, 0, 1, 0, 0, 0, 
                     0, 0, 0, 0, 0, 0, 0, 7, 11, 25, 40, 60, 88, 119, 145, 390, 1006, 
                     1762, 1974, 2216, 2648, 2489, 2810, 2764, 2146, 1335, 784, 442, 
                     152, 87, 50, 17, 19, 9, 10, 11, 2, 7, 6, 0, 1, 0, 0, 0, 0, 0, 
                     0, 1, 0, 0, 0, 1, 3, 3, 19, 94, 323, 699, 992, 1105, 1011, 1096, 
                     1329, 997, 1114, 1026, 838, 568, 433, 303, 270, 158, 84, 42, 
                     39, 34, 46, 26, 34, 9, 6, 6, 0, 0, 0, 1, 0, 0, 1, 6, 4, 58, 57, 
                     145, 99, 68, 78, 117, 331, 540, 1071, 1356, 1661, 1379, 1332, 
                     1253, 1461, 1261, 1149, 1031, 1013, 567, 279, 116, 35, 24, 10, 
                     5, 5, 0, 3, 3, 2, 2, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 25, 
                     27, 47, 42, 118, 441, 1078, 1610, 1748, 1892, 1722, 2024, 1918, 
                     2410, 2141, 1883, 1432, 1029, 565, 327, 125, 40, 15, 5, 3, 2, 
                     2, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 5, 1, 13, 60, 
                     194, 373, 579, 818, 1074, 1338, 1440, 1446, 1907, 2004, 1755, 
                     1092, 562, 497, 296, 220, 99, 51, 26, 11, 13, 6, 5, 3, 2, 3, 
                     2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 16, 39, 54, 165, 
                     549, 849, 1033, 1153, 1014, 1042, 1229, 1144, 745, 474, 393, 
                     249, 167, 74, 23, 14, 5, 2, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 
                     0, 0, 0, 0, 0, 1, 0, 3, 10, 31, 40, 81, 190, 492, 882, 1708, 
                     2822, 2318, 2046, 2754, 2400, 2004, 1177, 826, 392, 218, 103, 
                     68, 25, 14, 3, 2, 0, 3, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 12, 
                     25, 28, 32, 42, 71, 102, 261, 317, 812, 959, 1588, 2584, 2876, 
                     2588, 3622, 2357, 1745, 858, 818, 457, 306, 195, 123, 47, 18, 
                     14, 5, 4, 5, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 10, 47, 135, 
                     171, 363, 632, 1173, 1039, 1893, 1931, 2450, 2705, 2493, 2595, 
                     3530, 2527, 2074, 1154, 1581, 832, 496, 276, 125, 94, 53, 31, 
                     43, 16, 17, 3, 1, 0, 0, 0, 1), .Dim = c(42L, 18L), .Dimnames = list(
                       c("10.5", "11.5", "12.5", "13.5", "14.5", "15.5", "16.5", 
                         "17.5", "18.5", "19.5", "20.5", "21.5", "22.5", "23.5", "24.5", 
                         "25.5", "26.5", "27.5", "28.5", "29.5", "30.5", "31.5", "32.5", 
                         "33.5", "34.5", "35.5", "36.5", "37.5", "38.5", "39.5", "40.5", 
                         "41.5", "42.5", "43.5", "44.5", "45.5", "46.5", "47.5", "48.5", 
                         "49.5", "50.5", "51.5"), c("2000", "2001", "2002", "2003", 
                                                    "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", 
                                                    "2012", "2013", "2014", "2015", "2016", "2017")))


#########################################
################ CPUE data ##############
#########################################

It_data=c(#21.85, 24.53, 25.78, 31.81, 28.76, 30.96, 
  27.3, 19.3, 16.5, 18, 10.4, 13.1, 10, 11.42, 7.95, 3.87, 7.75, 8.49, 12.79, 14.47, 10.1,
  12.03, 12.47, 15.07, 17.45, 12.66, 32.44, 16.19, 18.17, 16.73, 12.8, 16.64, 14.22,
  15.26, 22.33, 15.74, 12.65, 18.93, 27.47, 26.22, 17.77, 26.93, 25.11, 19.3, 21.55, 
  21.08, 20.16, 16.46, 29.69, 26.39)

names(It_data) <-1976:2019




###########################################
################ vessel data ##############
###########################################


vessel_data=structure(c(342, 329, 327, NA, NA, 280, 251, 238, 232, 219, 220, 
                        210, 190, 188, 191, 191, 175, 154, 153, 143, 143, 143, 143, 146, 
                        144, 145, 142, 151, 111, 44651.72, 43454.16, 43494.11, NA, NA, 
                        37047.05, 32481.74, 32060.05, 31376.86, 29546.11, 29511.5, 28463.36, 
                        25880.17, 25663.61, 26191.48, 28004.31, 24491.4, 22614.45, 22360.93, 
                        21959.24, 22235.24, 22834.2, 22846.55, 23866.55, 23767.55, 24310.25, 
                        23712.25, 25161.25, 19509, 282924, 289211, 295383, NA, NA, 279551, 
                        259070, 256416, 255927, 252840, 255641, 246957, 194166, 176881, 
                        228933, 236838, 220834, 200451, 200426, 196009, 195559, 198771, 
                        197688, 203783, 202314, 205282, 199828, 212148, 160220), .Dim = c(29L, 
                                                                              3L), .Dimnames = list(c("1992", "1993", "1994", "1995", "1996", 
                                                                                                      "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", 
                                                                                                      "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                                                                                      "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020"
                                                                              ), c("nvessel", "ton", "horsepower")))

############################################################################################################################################
############################################################################################################################################
############################################################################################################################################

## number of age groups
A=6

## number of years
nyears=length(catch_data)

## length-weight relationship
alpha=0.003*1e-6
beta=3.425

## maturity
mat1=20.11
mat2=0.70

## length bins
bins=10.5:51.5


SpawningTimeElapse=0.5
FemaleProp=0.5
LengthFreqYears=50:67
cpueYears=26:69
ncpue=44
nLengthFreq=18


## mean lengths
MeanLengths=c(23.9, 27.8, 30.6, 34.8, 37.2, 40.1, 42.7)

## Maturity
Maturity=1/( 1+exp(mat1-mat2*MeanLengths[1:A]))

## Length-weight
LengthWeight=alpha*MeanLengths[1:A]^beta


#############################################################################################################################################################################################################
#############################################################################################################################################################################################################
#############################################################################################################################################################################################################

## Length Distribution ##

binwidth=bins[2]-bins[1]

model <- function(x, parms) {
  omega = x[1]
  alpha = x[2]
  m = parms[1]
  p5 = parms[2]
  p95 = parms[3]
  xi = m - omega*alpha*sqrt(2/(pi*(1+alpha^2)))
  c(F1 = p5 - qsn(0.05, xi, omega, alpha),
    F2 = p95 - qsn(0.95, xi, omega, alpha))
}


AgeSkewNorm <-function(x, parms) {
  
  sol = multiroot(model, x, parms=parms)
  
  mean=parms[1]
  
  omega=sol$root[1]
  
  alpha=sol$root[2]
  
  xi=mean - omega*alpha*sqrt(2/(pi*(1+alpha^2)))
  
  return(list("xi"=xi,
              "omega"=omega,
              "alpha"=alpha))
}




Age_Mean_Quantiles=list("age0"=c(23.9, 19.1, 29),
                        "age1"=c(27.8, 23.1, 33),
                        "age2"=c(30.6, 26.1, 36),
                        "age3"=c(34.8, 30.1, 42),
                        "age4"=c(37.2, 31.1, 43),
                        "age5"=c(40.1, 35.1, 44),
                        "age6"=c(42.7, 39.1, 46))


age0=AgeSkewNorm(x=c(30, 0.4), parms=Age_Mean_Quantiles[[1]])
age1=AgeSkewNorm(x=c(30, 0.4), parms=Age_Mean_Quantiles[[2]])
age2=AgeSkewNorm(x=c(30, 0.4), parms=Age_Mean_Quantiles[[3]])
age3=AgeSkewNorm(x=c(30, 0.4), parms=Age_Mean_Quantiles[[4]])
age4=AgeSkewNorm(x=c(100, 0.5), parms=Age_Mean_Quantiles[[5]])
age5=AgeSkewNorm(x=c(200, 1.5), parms=Age_Mean_Quantiles[[6]])
age6=AgeSkewNorm(x=c(300, 2.5), parms=Age_Mean_Quantiles[[7]])

DistPars=list("age0"=unlist(age0),
              "age1"=unlist(age1),
              "age2"=unlist(age2),
              "age3"=unlist(age3),
              "age4"=unlist(age4),
              "age5"=unlist(age5),
              "age6"=unlist(age6)) 


nbins=length(bins)

AgeLengDist=matrix(0, nrow=A, ncol=nbins)

for (a in 1:A) {
  for (i in 1:nbins) {
    if(i==1) {
    AgeLengDist[a,i]=psn(bins[i]+binwidth/2, xi=DistPars[[a]]["xi"], omega=DistPars[[a]]["omega"], alpha=DistPars[[a]]["alpha"])
    } else if (i>1 | i<nbins) {
      AgeLengDist[a,i]=psn(bins[i]+binwidth/2, xi=DistPars[[a]]["xi"], omega=DistPars[[a]]["omega"], alpha=DistPars[[a]]["alpha"])-psn(bins[i]-binwidth/2, xi=DistPars[[a]]["xi"], omega=DistPars[[a]]["omega"], alpha=DistPars[[a]]["alpha"])
    } else if (i==nbins){
      AgeLengDist[a,i]=1-psn(bins[i]-binwidth/2, xi=DistPars[[a]]["xi"], omega=DistPars[[a]]["omega"], alpha=DistPars[[a]]["alpha"])
    }
  }
}








invlogit <-function(y) {
  1/(1 + exp(-y))
}

